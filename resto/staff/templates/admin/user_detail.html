{% extends "admin/base_admin.html" %}
{% block title %}Utilisateur{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h1 class="h5 mb-1">{{ u.username }}</h1>
    <div class="text-muted small">{{ u.email|default:"-" }}</div>
  </div>
  <a class="btn btn-sm btn-outline-secondary" href="{% url 'staff:admin_user_list' %}">
    Retour
  </a>
</div>

<div class="row g-3">

  <!-- Colonne gauche : infos + fid√©lit√© + stats -->
  <div class="col-lg-4">

    <!-- Infos utilisateur -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between mb-2">
          <span class="text-muted">Inscription</span>
          <span class="fw-semibold">{{ u.date_joined|date:"d/m/Y H:i" }}</span>
        </div>

        <div class="d-flex justify-content-between mb-2">
          <span class="text-muted">Staff</span>
          <span class="fw-semibold">{% if u.is_staff %}Oui{% else %}Non{% endif %}</span>
        </div>

        <div class="d-flex justify-content-between mb-2">
          <span class="text-muted">Total d√©pens√© (livr√©)</span>
          <span class="fw-semibold">{{ total_spent }} FCFA</span>
        </div>

        <hr class="my-3">

        <!-- Fid√©lit√© -->
        <h2 class="h6 mb-2">Fid√©lit√©</h2>
        <span class="text-muted">500 FCFA</span>
        <span class="fw-semibold">{{ c500|default:0 }}/8</span>
      </div>
      {% if next_500 > 0 %}
        <div class="text-muted small mb-2">Prochain bon 500 dans {{ next_500 }} plat(s).</div>
      {% else %}
        <div class="text-muted small mb-2">Bon 500 pr√™t (√† la prochaine livraison si g√©n√©ration activ√©e).</div>
      {% endif %}

      <div class="d-flex justify-content-between">
        <span class="text-muted">1000 FCFA</span>
        <span class="fw-semibold">{{ c1000|default:0 }}/8</span>
      </div>
      {% if next_1000 > 0 %}
        <div class="text-muted small mb-2">Prochain bon 1000 dans {{ next_1000 }} plat(s).</div>
      {% else %}
        <div class="text-muted small mb-2">Bon 1000 pr√™t (√† la prochaine livraison si g√©n√©ration activ√©e).</div>
      {% endif %}

      <div class="d-flex justify-content-between">
        <span class="text-muted">1500 FCFA</span>
        <span class="fw-semibold">{{ c1500|default:0 }}/8</span>
      </div>
      {% if next_1500 > 0 %}
        <div class="text-muted small mb-2">Prochain bon 1500 dans {{ next_1500 }} plat(s).</div>
      {% else %}
        <div class="text-muted small mb-2">Bon 1500 pr√™t (√† la prochaine livraison si g√©n√©ration activ√©e).</div>
      {% endif %}

      <div class="d-flex justify-content-between mt-2">
       <h3 class="h6 mb-2">Bons disponibles</h3>

        {% if vouchers_available and vouchers_available|length > 0 %}

          <div class="mb-2">
            <div class="fw-semibold">500 FCFA</div>
            {% if v500|length > 0 %}
              <ul class="small mb-2">
                {% for v in v500 %}
                  <li>
                    Bon #{{ v.id }} ‚Äî expire le {{ v.expires_at|date:"d/m/Y" }}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="text-muted small mb-2">Aucun bon 500.</div>
            {% endif %}

            <div class="fw-semibold">1000 FCFA</div>
            {% if v1000|length > 0 %}
              <ul class="small mb-2">
                {% for v in v1000 %}
                  <li>
                    Bon #{{ v.id }} ‚Äî expire le {{ v.expires_at|date:"d/m/Y" }}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="text-muted small mb-2">Aucun bon 1000.</div>
            {% endif %}

            <div class="fw-semibold">1500 FCFA</div>
            {% if v1500|length > 0 %}
              <ul class="small mb-0">
                {% for v in v1500 %}
                  <li>
                    Bon #{{ v.id }} ‚Äî expire le {{ v.expires_at|date:"d/m/Y" }}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="text-muted small">Aucun bon 1500.</div>
            {% endif %}
          </div>

          <div class="text-muted small">
            R√®gle : un bon 500/1000/1500 s‚Äôapplique uniquement sur un plat du m√™me prix.
            Le syst√®me utilise automatiquement le bon qui expire le plus t√¥t et qui correspond √† ton panier.
          </div>

        {% else %}
          <div class="text-muted small">
            Aucun bon disponible pour le moment.
          </div>
        {% endif %}
      </div>

      <div class="text-muted small mt-2">
        R√®gle : 8 achats d‚Äôun m√™me prix ‚Üí 1 bon du m√™me prix. Pas de ‚Äúmont√©e en gamme‚Äù gratuite.
      </div>

      </div>
    </div>

    <!-- Stats par statut -->
    <div class="card shadow-sm mt-3">
      <div class="card-body">
        <h2 class="h6 mb-2">Commandes par statut</h2>

        <div class="d-flex justify-content-between small mb-1">
          <span class="text-muted">En attente</span>
          <span class="fw-semibold">{{ counts.pending|default:0 }}</span>
        </div>

        <div class="d-flex justify-content-between small mb-1">
          <span class="text-muted">Confirm√©es</span>
          <span class="fw-semibold">{{ counts.confirmed|default:0 }}</span>
        </div>

        <div class="d-flex justify-content-between small mb-1">
          <span class="text-muted">Livr√©es</span>
          <span class="fw-semibold">{{ counts.delivered|default:0 }}</span>
        </div>

        <div class="d-flex justify-content-between small">
          <span class="text-muted">Annul√©es</span>
          <span class="fw-semibold">{{ counts.canceled|default:0 }}</span>
        </div>
      </div>
    </div>

  </div>

  <!-- Colonne droite : commandes + vouchers -->
  <div class="col-lg-8">

    <!-- Derni√®res commandes -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="h6 mb-3">Derni√®res commandes</h2>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>ID</th>
                <th>Date</th>
                <th>Total</th>
                <th>Avantage</th>
                <th>Statut</th>
              </tr>
            </thead>

            <tbody>
              {% for o in orders %}
                <tr>
                  <td>#{{ o.id }}</td>
                  <td>{{ o.created_at|date:"d/m/Y H:i" }}</td>
                  <td class="fw-semibold">{{ o.total }} FCFA</td>

                  <!-- Avantage : voucher > promo > rien -->
                  <td>
                    {% if o.used_vouchers.all|length > 0 %}
                      <span class="badge bg-success">üéÅ Plat gratuit</span>
                    {% elif o.promo_code %}
                      <span class="badge bg-info text-dark">üè∑Ô∏è Promo</span>
                    {% else %}
                      <span class="text-muted small">‚Äî</span>
                    {% endif %}
                  </td>

                  <td>{{ o.get_status_display }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="5" class="text-center text-muted py-3">
                    Aucune commande.
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="text-muted small mt-3">
          Note : ‚ÄúPlat gratuit‚Äù appara√Æt uniquement si un voucher a √©t√© <strong>consomm√©</strong> sur cette commande
          (donc un objet <code>FreeItemVoucher</code> avec <code>status=USED</code> et <code>used_order=#ID</code>).
        </div>

      </div>
    </div>

    <!-- Vouchers (liste) -->
    <div class="card shadow-sm mt-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h3 class="h6 fw-bold mb-0">Bons (vouchers)</h3>
          <span class="text-muted small">Derniers 10</span>
        </div>

        <div class="text-muted small mt-2">
          Un bon est cr√©√© quand les tampons d√©passent 8 au moment d‚Äôune commande livr√©e.
          Il peut ensuite √™tre utilis√© automatiquement sur une commande suivante.
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm mb-0 align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Statut</th>
              <th>Valeur max</th>
              <th>Expire</th>
              <th>Commande utilis√©e</th>
            </tr>
          </thead>

          <tbody>
            {% for v in vouchers %}
              <tr>
                <td>#{{ v.id }}</td>

                <td>
                  {% if v.status == "AVAILABLE" %}
                    <span class="badge bg-success">AVAILABLE</span>
                  {% elif v.status == "USED" %}
                    <span class="badge bg-secondary">USED</span>
                  {% elif v.status == "EXPIRED" %}
                    <span class="badge bg-danger">EXPIRED</span>
                  {% else %}
                    <span class="badge bg-dark">{{ v.status }}</span>
                  {% endif %}
                </td>

                <td>{{ v.max_tier_value }} FCFA</td>
                <td>{{ v.expires_at|date:"d/m/Y" }}</td>

                <td>
                  {% if v.used_order %}
                    #{{ v.used_order.id }}
                  {% else %}
                    <span class="text-muted">‚Äî</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted py-3">
                  Aucun voucher.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>

  </div>
</div>
{% endblock %}
