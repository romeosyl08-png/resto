{% extends "base.html" %}

{% block title %}Checkout – Resto{% endblock %}

{% block content %}
<h1 class="h3 mb-4">Finaliser la commande</h1>

<div class="row">
  <div class="col-md-6 mb-4">
    <h2 class="h5">Récapitulatif</h2>
    <ul class="list-group mb-3">
      {% for item in cart %}
        <li class="list-group-item d-flex justify-content-between align-items-start">
          <div class="me-3">
            <div class="fw-semibold">{{ item.meal.name }}</div>
            <div class="text-muted small">
              Variante: {{ item.variant_code }} • Qté: {{ item.quantity }}
            </div>
          </div>
          <div class="fw-semibold">{{ item.total_price }} FCFA</div>
        </li>
      {% endfor %}
    </ul>

      <ul class="list-group">
        <li class="list-group-item d-flex justify-content-between">
          <span>Sous-total</span>
          <span>{{ cart.get_subtotal_price }} FCFA</span>
        </li>

        <li class="list-group-item d-flex justify-content-between">
          <span>Remise {% if cart.promo_code %}({{ cart.promo_code }}){% endif %}</span>
          <span>- {{ cart.get_discount_amount }} FCFA</span>
        </li>

        <li class="list-group-item d-flex justify-content-between fw-bold">
          <span>Total</span>
          <span>{{ cart.get_total_after_discount }} FCFA</span>
        </li>
    </ul>
  </div>

  <div class="col-md-6">
    <h2 class="h5">Informations de livraison</h2>
    <form method="post" class="card card-body shadow-sm">
        {% csrf_token %}

        <div class="mb-3">
          {{ form.customer_name.label_tag }}
          {{ form.customer_name }}
          {% if form.customer_name.errors %}<div class="text-danger small">{{ form.customer_name.errors }}</div>{% endif %}
        </div>

        <div class="mb-3">
          {{ form.phone.label_tag }}
          {{ form.phone }}
          {% if form.phone.errors %}<div class="text-danger small">{{ form.phone.errors }}</div>{% endif %}
        </div>

        <div class="mb-3">
          {{ form.address.label_tag }}
          {{ form.address }}
          {% if form.address.errors %}<div class="text-danger small">{{ form.address.errors }}</div>{% endif %}
        </div>
        <div id="other-address-block" class="mb-3 d-none">
          {{ form.address_detail.label_tag }}
          {{ form.address_detail }}
          {% if form.address_detail.errors %}
            <div class="text-danger small">{{ form.address_detail.errors }}</div>
          {% endif %}
        </div>


        <div id="delivery-warning" class="alert alert-danger d-none">
          Livraison non incluse. Le client organise et paie la livraison (Yango/Glovo).
        </div>
        <button type="submit" class="btn btn-success w-100">Confirmer la commande</button>
      </form>

      <script>
        (function(){
          const select = document.getElementById("id_address");
          const warn = document.getElementById("delivery-warning");
          const otherBlock = document.getElementById("other-address-block");

          function sync(){
            const isOther = select && select.value === "other";
            if (warn) warn.classList.toggle("d-none", !isOther);
            if (otherBlock) otherBlock.classList.toggle("d-none", !isOther);
          }

          if (select) {
            select.addEventListener("change", sync);
            sync();
          }
        })();
      </script>
  </div>


  
</div>
{% endblock %}
